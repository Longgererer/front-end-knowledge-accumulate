# 浏览器进程与线程

## 进程与线程之间的关系

一个进程包含一到多个线程，线程之间共同完成进程分配下来的任务，比如：

进程是 cpu 资源分配的最小单位(是能拥有资源和独立运行的最小单位)，线程是 cpu 调度的最小单位(线程是建立在进程的基础上的一次程序运行单位)。

一个程序至少拥有一个进程，一个进程至少拥有一个线程。

进程在执行过程中拥有独立的内存单元，而多个线程共享内存，从而极大地提高了程序的运行效率。

如果你把进程看作是工厂，而线程就是工人，上面的话就很好理解了。

## 浏览器中的进程

浏览器是多进程的，它包含有：

- **主进程**。
  - 负责浏览器界面显示，与用户交互。如前进，后退等。
  - 负责各个页面的管理，创建和销毁其他进程。
  - 将渲染（Renderer）进程得到的内存中的 Bitmap（位图），绘制到用户界面上。
  - 网络资源的管理，下载等。
- **第三方插件进程**，浏览器会为每一个插件开启一个进程，只有使用该插件的时候才会创建相应的进程。
- **GPU 进程**，用于显卡硬件加速，在你用浏览器观看高清视频或渲染 3D 图形的会开启，最多只有一个进程。
- **渲染进程**，每开启一个标签页就会多一个进程，负责页面渲染、脚本执行和时间处理等。

有时会有其他情况：

- 如果页面中有 iframe，iframe 也会运行在单独的进程中。
- 如果两个页面属于同一个站点，并且 B 页面是从 A 页面中打开的，那么他们会共用一个渲染进程。

## 渲染进程

渲染进程包含 5 个线程，如下：

1. **GUI 渲染线程**
   - 负责渲染浏览器界面，包括解析 HTML、CSS、构建 DOM 树、Render 树、布局与绘制等。
   - 当界面需要重绘（Repaint）或由于某种操作引发回流(reflow)时，该线程就会执行。
2. **JS 引擎线程**
   - JS 内核，也称 JS 引擎，负责处理执行 javascript 脚本。
   - 等待任务队列的任务的到来，然后加以处理，浏览器无论什么时候都只有一个 JS 引擎在运行 JS 程序。
3. **事件触发线程**
   - 用来控制事件循环，该线程归浏览器而不是 JS 引擎所控制。
   - 当 JS 引擎异步代码时，会将对应的异步任务添加到事件线程中等待处理。
   - 当对应的事件符合触发条件被触发时，该线程会把事件添加到事件队列的队尾，等待 JS 引擎的处理。
4. **定时器线程**
   - 当执行 `setTimeout` 和 `setInterval` 时就会开始计时，当计时完成后添加到时间队列，等待 JS 引擎执行。
5. ***

:::tip Notice
定时器线程是独立出来的一个线程，因为如果由 JS 引擎计时，当处于堵塞状态时计时将会出现差错。但计时器中的事件仍然可能会因为其他任务的阻塞延迟执行。
:::

## 单线程的 JS

实际上，所有涉及到 UI 处理的都必须是单线程，如在 Android 中，所有处理 UI 的代码必须在主线程中执行，这是为了防止其他子线程中的代码操作 UI 造成冲突。JS 现在虽然可以使用 web worker 开启新的子线程，但只能做计算，不能操作 UI。

## GUI 线程与 JS 线程

GUI 线程与 JS 线程是互斥的，页面进行渲染时，不能执行 JS 代码；JS 代码的执行会阻塞页面渲染。同样是为了避免 JS 中操作 UI 带来的结果不一致。

## 参考文章

- [浅谈浏览器多进程与 JS 线程](https://segmentfault.com/a/1190000013083967)
- [线程与进程的区别](https://blog.csdn.net/weixin_39430694/article/details/78518080)
- [浏览器的运行机制—2.浏览器都包含哪些进程？](https://www.jianshu.com/p/1e455a9226ce)
