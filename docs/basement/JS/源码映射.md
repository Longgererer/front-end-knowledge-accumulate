# Source map

**æºæ˜ å°„**æŒ‡çš„æ˜¯å°†è½¬æ¢ä¹‹åçš„ä»£ç æ˜ å°„å›åŸæ¥çš„ä»£ç ï¼Œæ¯”å¦‚åœ¨æˆ‘ä»¬è¿›è¡Œé¡¹ç›®çš„ç”Ÿäº§æ„å»ºæ—¶ï¼Œå¸¸å¸¸ä¼šå°†ä»£ç è¿›è¡Œå‹ç¼©ä»¥æå‡è¿è¡Œæ•ˆç‡ã€‚

æºç è½¬æ¢é€šå¸¸å­˜åœ¨äºä»¥ä¸‹å‡ ç§æƒ…å†µï¼š

- å‹ç¼©ä»£ç ä»è€Œå‡å°ä½“ç§¯ã€‚
- åˆå¹¶å¤šä¸ªæ–‡ä»¶ä»¥å‡å°‘ `http` è¯·æ±‚æ•°ã€‚
- ç¼–è¯‘å…¶ä»–é¢„å¤„ç†è¯­è¨€ã€‚

ä½†æ‰“åŒ…ä¹‹åçš„ä»£ç å¸¸å¸¸æ™¦æ¶©éš¾æ‡‚ï¼Œå¹¶ä¸”å¼€å‘ä»£ç ä¸ç”¨äºè¿è¡Œä»£ç ï¼Œä¸å¥½è°ƒè¯•ã€‚

å½“æˆ‘ä»¬ç›´æ¥è¿è¡Œæ²¡ç»è¿‡å¤„ç†çš„ä»£ç ï¼Œå‡ºç°äº†é—®é¢˜æˆ‘ä»¬å¯ä»¥ç¬¬ä¸€æ—¶é—´å®šä½åˆ°é”™è¯¯ä»£ç çš„ä½ç½®ã€‚ä½†å¯¹äºå¤„ç†è¿‡çš„ï¼Œæ¯”å¦‚å‹ç¼©åçš„ä»£ç ï¼Œä½ æ ¹æœ¬çœ‹ä¸å‡ºå®ƒæ‰€å¯¹åº”çš„æºç ä½ç½®åœ¨å“ªé‡Œã€‚

![](http://picstore.lliiooiill.cn/1627370529%281%29.jpg)

è¿™å°±æ˜¯å‹ç¼©è¿‡åçš„ä»£ç ï¼Œè®²çœŸï¼ŒğŸ¶ éƒ½ä¸çœ‹ã€‚

åœ¨æˆ‘ä»¬ä½¿ç”¨æ‰“åŒ…å·¥å…·å¦‚ Webpackï¼ŒRollup ç­‰ï¼Œé…ç½®äº† `SourceMap` å(å¼€å‘ç¯å¢ƒä¸‹ä¼šè‡ªåŠ¨å¼€å¯è¯¥åŠŸèƒ½)ã€‚

## Webpack çš„ Source map

åœ¨ Webpack ä¸­(è¿™é‡Œç‰¹æŒ‡ Webpack5)ï¼Œé…ç½® `devtool` å±æ€§å¯ä»¥å¼€å¯æºç æ˜ å°„åŠŸèƒ½ï¼ŒWebpack æœ‰å‡ åç§ Source map é…ç½®ï¼Œå› æ­¤è¿™é‡Œä¸å¤šè®²ï¼Œè¯¦æƒ…è¯·çœ‹ï¼š[Devtool](https://webpack.docschina.org/configuration/devtool/)ã€‚

å¯¹äºå¼€å‘ç¯å¢ƒï¼Œå®˜æ–¹è®¤ä¸ºæœ€ä½³çš„é…ç½®æ˜¯ `eval-source-map`ï¼Œè¿™è¡¨ç¤ºæ¯ä¸ªæ¨¡å—ä½¿ç”¨ `eval()` æ‰§è¡Œï¼Œå¹¶ä¸” Source map è½¬æ¢ä¸º DataUrl åæ·»åŠ åˆ° `eval()` ä¸­ã€‚åˆå§‹åŒ– Source map æ—¶æ¯”è¾ƒæ…¢ï¼Œä½†æ˜¯ä¼šåœ¨é‡æ–°æ„å»ºæ—¶æä¾›æ¯”è¾ƒå¿«çš„é€Ÿåº¦ï¼Œå¹¶ä¸”ç”Ÿæˆå®é™…çš„æ–‡ä»¶ã€‚è¡Œæ•°èƒ½å¤Ÿæ­£ç¡®æ˜ å°„ï¼Œå› ä¸ºä¼šæ˜ å°„åˆ°åŸå§‹ä»£ç ä¸­ã€‚å®ƒä¼šç”Ÿæˆç”¨äºå¼€å‘ç¯å¢ƒçš„æœ€ä½³å“è´¨çš„ Source mapã€‚

è®¸å¤šé¡¹ç›®ä½¿ç”¨ `eval` é…ç½® `devtool`ï¼Œè¿™æ ·ä¼šæ›´å¿«é€Ÿåœ°æ„å»ºé¡¹ç›®ï¼Œç”±äºä¼šæ˜ å°„åˆ°è½¬æ¢åçš„ä»£ç ï¼Œè€Œä¸æ˜¯æ˜ å°„åˆ°åŸå§‹ä»£ç ï¼Œæ‰€ä»¥ä¸èƒ½æ­£ç¡®çš„æ˜¾ç¤ºè¡Œæ•°ã€‚æ¯ä¸ªè¢«å¤„ç†çš„æ–‡ä»¶æœ€åä¸€è¡Œéƒ½ä¼šæœ‰ç±»ä¼¼çš„æ³¨é‡Šï¼š

```js
//@ sourceURL=...
```

è¡¨ç¤ºè¯¥æ–‡ä»¶å¯¹åº”çš„æºæ˜ å°„æ–‡ä»¶çš„ä½ç½®(åœ¨è€ç‰ˆæœ¬çš„ Webpack ä¸­æ˜¯ä½¿ç”¨ base64 æ ¼å¼çš„è·¯å¾„)ã€‚

:::tip Notice
å¹¶ä¸æ˜¯æ‰€æœ‰æµè§ˆå™¨éƒ½æ”¯æŒ Source mapï¼Œä¸€äº›æµè§ˆå™¨åªä¼šå°†æ–‡ä»¶æœ€ä¸‹é¢çš„ç‰¹æ®Šæ³¨é‡Šçœ‹æˆæ™®é€šæ³¨é‡Šã€‚
:::

## å¦‚ä½•å®ç°æ˜ å°„

è¯´äº†è¿™ä¹ˆå¤šï¼ŒåªçŸ¥é“ Source map æ˜¯ä»€ä¹ˆï¼Œé‚£ä¹ˆå®ƒæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ

> ä¸‹é¢å†…å®¹å¤§å¤šæ•°å‚è€ƒï¼š[JavaScript Source Map è¯¦è§£](http://www.ruanyifeng.com/blog/2013/01/javascript_source_map.html)ã€‚

ä¸€ä¸ª `.map` æ–‡ä»¶é€šå¸¸åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š

```js
{
  version : 3,
  file: "out.js",
  sourceRoot : "",
  sources: ["foo.js", "bar.js"],
  names: ["src", "maps", "are", "fun"],
  mappings: "AACvB,gBAAgB,EAAE;AAClB;"
}
```

- `version`ï¼šæºæ˜ å°„ç‰ˆæœ¬ã€‚
- `file`ï¼šè½¬æ¢åæ–‡ä»¶åã€‚
- `sourceRoot`ï¼šè½¬æ¢å‰æ–‡ä»¶æ‰€åœ¨ç›®å½•ã€‚å¦‚æœä¸è½¬æ¢å‰çš„æ–‡ä»¶åœ¨åŒä¸€ç›®å½•ï¼Œè¯¥é¡¹ä¸ºç©ºã€‚
- `sources`ï¼šè½¬æ¢å‰çš„æ–‡ä»¶ã€‚è¯¥é¡¹æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œè¡¨ç¤ºå¯èƒ½å­˜åœ¨å¤šä¸ªæ–‡ä»¶åˆå¹¶ã€‚
- `names`ï¼šè½¬æ¢å‰çš„æ‰€æœ‰å˜é‡åå’Œå±æ€§åã€‚
- `mappings`ï¼šè®°å½•ä½ç½®ä¿¡æ¯çš„å­—ç¬¦ä¸²ã€‚

`mappings` æ˜¯æ•´ä¸ªæ–‡ä»¶çš„å…³é”®ï¼Œè¯¥å±æ€§å€¼æ˜¯ä¸€ä¸ªå¾ˆé•¿çš„å­—ç¬¦ä¸²ï¼Œåˆ†ä¸ºä¸‰å±‚ï¼š

- **è¡Œå¯¹åº”**ï¼šæ¯ä¸€è¡Œä¹‹é—´ç”¨åˆ†å· `;` ç›¸éš”å¼€ï¼Œç¬¬ä¸€ä¸ªåˆ†å·å‰çš„å†…å®¹å°±æ˜¯ç¬¬ä¸€è¡Œï¼Œä»¥æ­¤ç±»æ¨ã€‚
- **ä½ç½®å¯¹åº”**ï¼šæ¯ä¸ªé€—å· `,` å¯¹åº”æºç ä¸­çš„ä¸€ä¸ªä½ç½®ï¼Œç¬¬ä¸€ä¸ªåˆ†å·å‰çš„å†…å®¹å°±æ˜¯è¯¥è¡Œæºç çš„ç¬¬ä¸€ä¸ªä½ç½®ï¼Œä»¥æ­¤ç±»æ¨ã€‚
- **ä½ç½®è½¬æ¢**ï¼šä»¥ VLQ ç¼–ç è¡¨ç¤ºï¼Œä»£è¡¨è¯¥ä½ç½®å¯¹åº”çš„è½¬æ¢å‰çš„æºç ä½ç½®ã€‚

æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œæ¯ä¸€ä¸ªä½ç½®éƒ½å¯¹åº”ç€å¤šä¸ª VLQ ç¼–ç ï¼Œæ¯ä¸ªç¼–ç ä½œç”¨ä¸åŒï¼š

- ç¬¬ä¸€ä½ï¼Œè¡¨ç¤ºè¿™ä¸ªä½ç½®åœ¨**è½¬æ¢åä»£ç **çš„ç¬¬å‡ åˆ—ã€‚
- ç¬¬äºŒä½ï¼Œè¡¨ç¤ºè¿™ä¸ªä½ç½®å±äº**sources å±æ€§**ä¸­çš„å“ªä¸€ä¸ªæ–‡ä»¶ã€‚
- ç¬¬ä¸‰ä½ï¼Œè¡¨ç¤ºè¿™ä¸ªä½ç½®å±äº**è½¬æ¢å‰ä»£ç **çš„ç¬¬å‡ è¡Œã€‚
- ç¬¬å››ä½ï¼Œè¡¨ç¤ºè¿™ä¸ªä½ç½®å±äº**è½¬æ¢å‰ä»£ç **çš„ç¬¬å‡ åˆ—ã€‚
- ç¬¬äº”ä½å’Œç¬¬å…­ä½ï¼Œè¡¨ç¤ºè¿™ä¸ªä½ç½®å±äº**names å±æ€§**çš„å“ªä¸€ä¸ªå˜é‡ã€‚

æ‰€æœ‰çš„å€¼éƒ½æ˜¯ä»¥ 0 ä½œä¸ºåŸºæ•°çš„ã€‚å…¶æ¬¡ï¼Œç¬¬äº”ä½å’Œç¬¬å…­ä½ä¸æ˜¯å¿…éœ€çš„ï¼Œå¦‚æœè¯¥ä½ç½®æ²¡æœ‰å¯¹åº” `names` å±æ€§ä¸­çš„å˜é‡ï¼Œå¯ä»¥çœç•¥ç¬¬äº”ä½å’Œç¬¬å…­ä½ã€‚å†æ¬¡ï¼Œæ¯ä¸€ä½éƒ½é‡‡ç”¨ VLQ ç¼–ç è¡¨ç¤ºï¼›ç”±äº VLQ ç¼–ç æ˜¯å˜é•¿çš„ï¼Œæ‰€ä»¥æ¯ä¸€ä½å¯ä»¥ç”±å¤šä¸ªå­—ç¬¦æ„æˆã€‚

## VLQ

VLQ(Variable-length quantity) æ˜¯ä¸€ç§é€šç”¨çš„ã€ä½¿ç”¨ä»»æ„ä½æ•°çš„äºŒè¿›åˆ¶æ¥è¡¨ç¤ºä¸€ä¸ªä»»æ„å¤§çš„æ•°å­—çš„ä¸€ç§ç¼–ç æ–¹å¼ã€‚è¿™ç§ç¼–ç æœ€æ—©ç”¨äº MIDI æ–‡ä»¶ï¼Œåæ¥è¢«å¤šç§æ ¼å¼é‡‡ç”¨ï¼Œå®ƒçš„ç‰¹ç‚¹å°±æ˜¯å¯ä»¥éå¸¸ç²¾ç®€åœ°è¡¨ç¤ºå¾ˆå¤§çš„æ•°å€¼ï¼Œç”¨æ¥èŠ‚çœç©ºé—´ã€‚

![](http://picstore.lliiooiill.cn/1627377573%281%29.jpg)

ä¸Šå›¾å°±æ˜¯ base64 ä½å­—ç¬¦å¯¹åº”çš„ç¼–ç è¡¨ã€‚

ä¸¾ä¸ªä¾‹å­ï¼š`MACdC`ï¼Œä»¥åè¿›åˆ¶æ•°å­—å¯è¡¨ç¤ºä¸º `12 0 2 29 2`ã€‚æˆ‘ä»¬çŸ¥é“æ•°å­—åœ¨è®¡ç®—æœºä¸­æ˜¯ä»¥äºŒè¿›åˆ¶å­˜å‚¨å’Œè®¡ç®—çš„ï¼Œ64 è¿›åˆ¶æ•°å¯ä»¥è¡¨ç¤ºä¸º 6 ä½ 2 è¿›åˆ¶æ•°ï¼Œæ‰€ä»¥åˆå¯ä»¥è½¬æ¢ä¸ºï¼š

```bash
12 --> 001100
0  --> 000000
2  --> 000010
29 --> 011101
2  --> 000010
```

åœ¨è¿™å…­ä½äºŒè¿›åˆ¶æ•°ä¸­ï¼š

- ç¬¬ä¸€ä½ï¼š**æ˜¯å¦è¿ç»­**ï¼Œä»£è¡¨è¿™ï¼–ä¸ªä½åé¢çš„ 6 ä¸ªä½ä¹Ÿå±äºåŒä¸€ä¸ªæ•°ã€‚å¦‚æœæ˜¯ 0ï¼Œè¡¨ç¤ºè¯¥æ•°å€¼åˆ°è¿™ 6 ä¸ªä½ç»“æŸã€‚
- ä¸­é—´å››ä½ï¼š**æ•°å€¼ä½**ã€‚
- æœ«ä½ï¼š**ç¬¦å·ä½**ï¼Œå¦‚æœæ˜¯ 0ï¼Œä»£è¡¨è¯¥æ•°å€¼æ˜¯ä¸€ä¸ªæ•´æ•°ã€‚å¦‚æœæ˜¯ 1 ä»£è¡¨è¯¥æ•°å€¼æ˜¯ä¸€ä¸ªè´Ÿæ•°ã€‚

ä¸­é—´ 4 ä½çš„äºŒè¿›åˆ¶æ•°ï¼Œç®—ä¸Šç¬¦å·ä½ï¼Œå¯ä»¥è¡¨ç¤º `[-15, 15]` åŒºé—´å†…çš„ 31 ä½æ•°ã€‚

å› æ­¤ï¼Œç®—æ•°å€¼ä½å’Œç¬¦å·ä½ï¼Œ`MACdC` çœŸæ­£ä»£è¡¨çš„å…¶å®æ˜¯ï¼š`6 0 1 -14 1`ã€‚ç›¸å¯¹åº”çš„æ˜¯ï¼š

- è½¬æ¢åä»£ç çš„ç¬¬ 7 åˆ—ã€‚
- ä»£ç å±äº `sources` ä¸­çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶ã€‚
- å±äºè½¬æ¢å‰ä»£ç çš„ç¬¬ 2 è¡Œã€‚
- å±äºè½¬æ¢å‰ä»£ç çš„ç›¸å¯¹ä½ç½®çš„ -13 åˆ—ã€‚
- å±äº `names` ä¸­çš„ç¬¬ 2 ä¸ªå˜é‡ã€‚

æˆ‘ä»¬æ¥çœ‹ä¸‹è¿™ä¸ªä¾‹å­(æ¥è‡ªäº[source map åŸç†åˆ†æ&vlq](http://www.qiutianaimeili.com/html/page/2019/05/89jrubx1soc.html))ï¼š

```js
{
  "sources":["test.js"],
  "names":["sayHello","name","console","log"],
  "mappings":"AAAA,SAASA,SAASC,MACdC,QAAQC,IAAI,SAAUF"
}
```

æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ `mappings` é‡Œé¢çš„ VLQ ç¼–ç ï¼ŒæŒ‰ç…§ç¼–ç è¡¨å¯ä»¥è½¬æ¢æˆï¼š

```bash
base64ç¼–ç       åè¿›åˆ¶        è½¬æˆäºŒè¿›åˆ¶å–å‡ºæ•°å€¼å’Œç¬¦å·ä½
  AAAA   --> 0 0 0 0     -->   0 0 0 0
  SAASA  --> 18 0 0 18 0 -->   9 0 0 9 0
  SAASC  --> 18 0 0 18 2 -->   9 0 0 9 1
  MACdC  --> 12 0 2 29 2 -->   6 0 1 -14 1
  QAAQC  --> 16 0 0 16 2 -->   8 0 0 8 1
  IAAI   --> 8 0 0 8     -->   4 0 0 4
  SAAUF  --> 18 0 0 20 5 -->   9 0 0 10 -2
```

å¾—å‡ºäº†æœ€ç»ˆçš„æ•°å€¼ï¼Œåœ¨çŸ¥é“æ¯ä¸€ä½æ‰€ä»£è¡¨çš„æ„ä¹‰ä¹‹åï¼Œæˆ‘ä»¬å°±èƒ½ç†è§£ VLQ ç¼–ç äº†ã€‚

## æ€»ç»“

å¯¹äºå‰ç«¯å¼€å‘æ¥è¯´ï¼Œ`Source map` æ˜¯éå¸¸å¿…è¦ä¸”å¥½ç”¨çš„ debug å·¥å…·ï¼Œå®ƒé€šè¿‡ VLQ ç¼–ç æ¥å®ç°æºä»£ç åˆ°æ‰“åŒ…åä»£ç çš„æ˜ å°„ã€‚

ä½†è¯·æ³¨æ„ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒä¸‹å¼€å¯ `Source map` è®©æˆ‘ä»¬å³ä½¿è¿è¡Œæ‰“åŒ…åçš„ä»£ç ä¹Ÿèƒ½æ‰¾å‡ºæºç ä¸­çš„é”™è¯¯ã€‚ä½†è¿™æ ·åšä¼šæ˜¾è‘—çš„å¢åŠ é¡¹ç›®åŒ…çš„å¤§å°ï¼Œå› ä¸ºé¡¹ç›®ä¸­ä¼šåŒ…å«è®¸å¤šæºæ˜ å°„ `.map` æ–‡ä»¶ã€‚

## å‚è€ƒæ–‡ç« 

- [JavaScript Source Map è¯¦è§£](http://www.ruanyifeng.com/blog/2013/01/javascript_source_map.html)
- [Introduction to JavaScript Source Maps](https://www.html5rocks.com/en/tutorials/developertools/sourcemaps/)
- [Devtool](https://webpack.docschina.org/configuration/devtool/)
- [å‰ç«¯é¢è¯•å®˜: ä½ çŸ¥é“ source-map çš„åŸç†æ˜¯ä»€ä¹ˆå—ï¼Ÿ](https://cloud.tencent.com/developer/article/1598223#:~:text=VLQ%E6%98%AFVariable-length,quantity%E7%9A%84%E7%BC%A9%E5%86%99%EF%BC%8C%E6%98%AF%E4%B8%80%E7%A7%8D%E9%80%9A%E7%94%A8%E7%9A%84%E3%80%81%E4%BD%BF%E7%94%A8%E4%BB%BB%E6%84%8F%E4%BD%8D%E6%95%B0%E7%9A%84%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%9D%A5%E8%A1%A8%E7%A4%BA%E4%B8%80%E4%B8%AA%E4%BB%BB%E6%84%8F%E5%A4%A7%E7%9A%84%E6%95%B0%E5%AD%97%E7%9A%84%E4%B8%80%E7%A7%8D%E7%BC%96%E7%A0%81%E6%96%B9%E5%BC%8F%E3%80%82)
- [js source map](https://www.notbucai.com/article/5ed4a269f49dc43b595ff51d#wow6)
- [source map åŸç†åˆ†æ&vlq](http://www.qiutianaimeili.com/html/page/2019/05/89jrubx1soc.html)
- [debug å·¥å…· â€”â€” source-map](https://www.jianshu.com/p/2fd1d3b9a7a1)
