<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>EventLoop | lliiooiill&#39;s FEKA</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.css">
    <meta name="description" content="Record the front-end knowledge I learned">
    
    <link rel="preload" href="/assets/css/0.styles.5b935326.css" as="style"><link rel="preload" href="/assets/js/app.c065364e.js" as="script"><link rel="preload" href="/assets/js/2.daf612bb.js" as="script"><link rel="preload" href="/assets/js/3.1c386dd8.js" as="script"><link rel="preload" href="/assets/js/61.915390d9.js" as="script"><link rel="prefetch" href="/assets/js/10.8bf56e9e.js"><link rel="prefetch" href="/assets/js/11.6fb3a52b.js"><link rel="prefetch" href="/assets/js/12.46a246c2.js"><link rel="prefetch" href="/assets/js/13.1d3d9e90.js"><link rel="prefetch" href="/assets/js/14.aca9debe.js"><link rel="prefetch" href="/assets/js/15.41e98dee.js"><link rel="prefetch" href="/assets/js/16.aa1de19d.js"><link rel="prefetch" href="/assets/js/17.1d332154.js"><link rel="prefetch" href="/assets/js/18.3a50bd6e.js"><link rel="prefetch" href="/assets/js/19.5701dcd8.js"><link rel="prefetch" href="/assets/js/20.3c01e798.js"><link rel="prefetch" href="/assets/js/21.f449fa98.js"><link rel="prefetch" href="/assets/js/22.67e3a8ca.js"><link rel="prefetch" href="/assets/js/23.b049fa6a.js"><link rel="prefetch" href="/assets/js/24.cba5bb31.js"><link rel="prefetch" href="/assets/js/25.70cc2818.js"><link rel="prefetch" href="/assets/js/26.e17f0893.js"><link rel="prefetch" href="/assets/js/27.fdd311ca.js"><link rel="prefetch" href="/assets/js/28.c20aac27.js"><link rel="prefetch" href="/assets/js/29.b510a2fc.js"><link rel="prefetch" href="/assets/js/30.2731e96d.js"><link rel="prefetch" href="/assets/js/31.246eeac4.js"><link rel="prefetch" href="/assets/js/32.c66b5415.js"><link rel="prefetch" href="/assets/js/33.54e4f95f.js"><link rel="prefetch" href="/assets/js/34.077d4c07.js"><link rel="prefetch" href="/assets/js/35.b260358a.js"><link rel="prefetch" href="/assets/js/36.a7b050ea.js"><link rel="prefetch" href="/assets/js/37.4b22ce60.js"><link rel="prefetch" href="/assets/js/38.ef826704.js"><link rel="prefetch" href="/assets/js/39.03b2a8aa.js"><link rel="prefetch" href="/assets/js/4.8b98ec8f.js"><link rel="prefetch" href="/assets/js/40.b7293f84.js"><link rel="prefetch" href="/assets/js/41.01a514d0.js"><link rel="prefetch" href="/assets/js/42.2e7f13ef.js"><link rel="prefetch" href="/assets/js/43.13ba815c.js"><link rel="prefetch" href="/assets/js/44.885d4b2a.js"><link rel="prefetch" href="/assets/js/45.8d912712.js"><link rel="prefetch" href="/assets/js/46.bc445534.js"><link rel="prefetch" href="/assets/js/47.bf275f12.js"><link rel="prefetch" href="/assets/js/48.a3bf96d3.js"><link rel="prefetch" href="/assets/js/49.2bb53222.js"><link rel="prefetch" href="/assets/js/5.a41536ef.js"><link rel="prefetch" href="/assets/js/50.2eb5f48d.js"><link rel="prefetch" href="/assets/js/51.aa85f296.js"><link rel="prefetch" href="/assets/js/52.d4b2a92b.js"><link rel="prefetch" href="/assets/js/53.670826a0.js"><link rel="prefetch" href="/assets/js/54.751de8ca.js"><link rel="prefetch" href="/assets/js/55.6a43c231.js"><link rel="prefetch" href="/assets/js/56.d29b63f6.js"><link rel="prefetch" href="/assets/js/57.febd30b4.js"><link rel="prefetch" href="/assets/js/58.aa378ddf.js"><link rel="prefetch" href="/assets/js/59.fed6aa00.js"><link rel="prefetch" href="/assets/js/6.a05bc05f.js"><link rel="prefetch" href="/assets/js/60.02ef52ec.js"><link rel="prefetch" href="/assets/js/62.bbdaa584.js"><link rel="prefetch" href="/assets/js/63.928bc0f1.js"><link rel="prefetch" href="/assets/js/64.401b2bc5.js"><link rel="prefetch" href="/assets/js/65.81e5f763.js"><link rel="prefetch" href="/assets/js/66.1b8ad02d.js"><link rel="prefetch" href="/assets/js/67.9639fdf0.js"><link rel="prefetch" href="/assets/js/68.7ada55ae.js"><link rel="prefetch" href="/assets/js/7.8a52176a.js"><link rel="prefetch" href="/assets/js/8.894c7662.js"><link rel="prefetch" href="/assets/js/9.2619d08d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.5b935326.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-51b244cd><header class="navbar" data-v-51b244cd><a href="/" class="home-link router-link-active"><!----> <span class="site-name">lliiooiill's FEKA</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/basement/" class="nav-link">
  基础
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/framework/" class="nav-link">
  框架
</a></div><div class="nav-item"><a href="/technicalTopics/" class="nav-link router-link-active">
  技术专题
</a></div><div class="nav-item"><a href="https://longgererer.github.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/Longgererer/front-end-knowledge-accumulate" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask" data-v-51b244cd></div> <aside class="sidebar sidebar sidebar-unfold" data-v-51b244cd><nav class="nav-links"><div class="nav-item"><a href="/basement/" class="nav-link">
  基础
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/framework/" class="nav-link">
  框架
</a></div><div class="nav-item"><a href="/technicalTopics/" class="nav-link router-link-active">
  技术专题
</a></div><div class="nav-item"><a href="https://longgererer.github.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/Longgererer/front-end-knowledge-accumulate" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/technicalTopics/" aria-current="page" class="sidebar-link">前端技术专题</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>技术专题</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/technicalTopics/EventLoop.html" aria-current="page" class="active sidebar-link">EventLoop</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technicalTopics/EventLoop.html#什么是-event-loop" class="sidebar-link">什么是 Event Loop</a></li><li class="sidebar-sub-header"><a href="/technicalTopics/EventLoop.html#单线程的-javascript" class="sidebar-link">单线程的 JavaScript</a></li><li class="sidebar-sub-header"><a href="/technicalTopics/EventLoop.html#详解-event-loop" class="sidebar-link">详解 Event Loop</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technicalTopics/EventLoop.html#宏任务和微任务" class="sidebar-link">宏任务和微任务</a></li></ul></li><li class="sidebar-sub-header"><a href="/technicalTopics/EventLoop.html#练习" class="sidebar-link">练习</a></li><li class="sidebar-sub-header"><a href="/technicalTopics/EventLoop.html#扩展" class="sidebar-link">扩展</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technicalTopics/EventLoop.html#requestanimationframe" class="sidebar-link">requestAnimationFrame</a></li></ul></li><li class="sidebar-sub-header"><a href="/technicalTopics/EventLoop.html#使用工具" class="sidebar-link">使用工具</a></li><li class="sidebar-sub-header"><a href="/technicalTopics/EventLoop.html#参考文章" class="sidebar-link">参考文章</a></li></ul></li><li><a href="/technicalTopics/前端模块化发展.html" class="sidebar-link">前端模块化发展</a></li><li><a href="/technicalTopics/浏览器渲染原理.html" class="sidebar-link">浏览器渲染原理</a></li><li><a href="/technicalTopics/状态管理.html" class="sidebar-link">状态管理</a></li><li><a href="/technicalTopics/浏览器缓存机制.html" class="sidebar-link">浏览器缓存机制</a></li><li><a href="/technicalTopics/Git详解.html" class="sidebar-link">Git 详解</a></li><li><a href="/technicalTopics/14种JavaScript设计模式.html" class="sidebar-link">14 种 JavaScript 设计模式</a></li><li><a href="/technicalTopics/Vite是什么？.html" class="sidebar-link">Vite 是什么？</a></li><li><a href="/technicalTopics/AST详解.html" class="sidebar-link">AST 详解</a></li></ul></section></li></ul> </aside> <div class="sidebar-button sidebar-button" data-v-51b244cd><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <main class="page" data-v-51b244cd> <div class="theme-default-content content__default"><h1 id="eventloop"><a href="#eventloop" class="header-anchor">#</a> EventLoop</h1> <h2 id="什么是-event-loop"><a href="#什么是-event-loop" class="header-anchor">#</a> 什么是 Event Loop</h2> <p>关于 Event Loop 的定义，MDN 上对其进行了解释：</p> <blockquote><p>JavaScript has a concurrency model based on an event loop, which is responsible for executing the code, collecting and processing events, and executing queued sub-tasks.</p></blockquote> <p>大意为：Event Loop 是一个基于<strong>事件循环</strong>的并发模型，事件循环负责执行代码、收集和处理事件以及执行队列中的子任务。</p> <p>具体是什么呢？这就要说说<strong>执行栈</strong>和<strong>事件队列</strong>了：</p> <p>执行栈也被叫做调用栈，既然是栈，当然是遵循先进后出，后进先出的顺序，这个执行栈用于<strong>储存代码在执行期间创建的所有执行上下文</strong>。</p> <p>我们可以用一小段代码来更好地解释执行栈：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'123'</span><span class="token punctuation">)</span>
  <span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'456'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>这段代码执行的时候，执行栈中发生了这些事情：</p> <ul><li>首先执行函数 a，a 入栈</li> <li>执行<code>console.log('123')</code>，<code>console.log('123')</code>入栈</li> <li><code>console.log('123')</code>出栈，执行函数 b，b 入栈</li> <li>执行<code>console.log('456')</code>，<code>console.log('456')</code>入栈</li> <li><code>console.log('456')</code>出栈</li> <li>函数 b 出栈</li> <li>函数 a 出栈</li></ul> <p>配合 gif 食用更好理解：</p> <p><a data-fancybox="" title="GIF.gif" href="http://picstore.lliiooiill.cn/FdoiGN4ckPnzxVO.gif"><img src="http://picstore.lliiooiill.cn/FdoiGN4ckPnzxVO.gif" alt="GIF.gif"></a></p> <p>以上的结果是在执行同步代码的情况下，如果是执行异步代码就不是这样子了，因为异步是非阻塞的，所以它们会被挂起放到特定队列中，也就是<strong>事件队列</strong>，继续执行执行栈中的其他同步任务，等待同步任务执行完毕，执行栈空了，才会将队列中的异步事件依次取出入栈执行。</p> <h2 id="单线程的-javascript"><a href="#单线程的-javascript" class="header-anchor">#</a> 单线程的 JavaScript</h2> <p>所谓的 “JavaScript 是单线程的” 并不是说 JavaScript 和单线程多线程有任何关系，而是说 JavaScript 运行的环境决定了它是已单线程的形式运行的。</p> <p>H5 中有一个新特性 Web worker，虽然可以新开辟一个新线程，但这个线程仍然只是依托在主线程下面的子线程，并且不可以操作 dom 结点以及文件访问，只能进行运算和 AJAX 请求（子线程和主线程的异步请求都共用同一个 Event Loop），因此这只是个模拟出来的多线程，不代表 JavaScript 真的是以多线程形式运行。</p> <h2 id="详解-event-loop"><a href="#详解-event-loop" class="header-anchor">#</a> 详解 Event Loop</h2> <p>把该了解的都了解了，就要进入正题了：异步代码是按照什么顺序执行的？</p> <p>异步和同步不同，显然不是按照从上到下的顺序依次执行，来看看下面的代码：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'start'</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'console'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>不用我说，输出顺序是 <code>start end console</code>，代码执行中发生了这些事情：</p> <ul><li><code>console.log('start')</code> 压入栈中执行，执行完出栈</li> <li><code>setTimeout</code> 入栈，这时浏览器的<strong>定时触发线程</strong>开始计时</li> <li><code>console.log('end')</code> 压入栈中执行，执行完出栈</li> <li>1000 毫秒计时结束，将回调函数放到事件队列中</li> <li>检查执行栈中是否为空，执行栈为空，将事件队列中的回调函数取出放入执行栈执行，执行完出栈</li></ul> <p><a data-fancybox="" title="GIF.gif" href="http://picstore.lliiooiill.cn/qD3ioK21lHRxVbz.gif"><img src="http://picstore.lliiooiill.cn/qD3ioK21lHRxVbz.gif" alt="GIF.gif"></a></p> <p>综上所述，我们可以得知这个定时器里的 1000，并不代表程序运行 1000 毫秒后会准时执行回调函数，而是将回调放到事件队列中而已，真正执行回调的延迟时间肯定大于 1000 毫秒。</p> <p>明白了这个道理，<code>setTimeout(()=&gt;{}, 0)</code> 我们也能明白就是在执行栈为空的时候立即执行回调，而不是一运行程序就马上执行回调。</p> <h3 id="宏任务和微任务"><a href="#宏任务和微任务" class="header-anchor">#</a> 宏任务和微任务</h3> <p>我们知道，异步回调会被放入事件队列中，实际上，事件队列分为两种：<strong>宏任务</strong>(macro-task)队列和<strong>微任务</strong>(micro-task)队列，来看看常见异步任务对应的队列：</p> <p><strong>宏任务</strong>：</p> <ul><li>script 整体代码</li> <li>setTimeout</li> <li>setInterval</li> <li>I/O</li> <li>dom 绑定事件</li> <li>postMessage</li> <li>MessageChannel</li> <li>requestAnimationFrame</li> <li>setImmediate(node.js)</li></ul> <p><strong>微任务</strong>：</p> <ul><li>Promise.then</li> <li>Object.observe(废弃)</li> <li>MutaionObserver</li> <li>process.nextTick(node.js)</li></ul> <p>那么宏任务和微任务的执行顺序又是如何呢？</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'start'</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'newPromise'</span><span class="token punctuation">)</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'then'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>输出顺序：<code>start newPromise end then setTimeout</code>。</p> <p>简要说下大致执行流程：</p> <ul><li>执行宏任务(整个 script)</li> <li>输出 start</li> <li>将 setTimeout 回调放入宏任务队列</li> <li>输出 newPromise</li> <li>将 promise.then 回调放入微任务队列</li> <li>输出 end</li> <li>第一轮结束，检查微任务队列是否为空</li> <li>执行所有微任务</li> <li>输出 then</li> <li>第二轮结束，检查宏任务队列是否为空</li> <li>执行所有宏任务</li> <li>输出 setTimeout</li></ul> <p><a data-fancybox="" title="GIF.gif" href="http://picstore.lliiooiill.cn/sBJuhIkD8Wv9XoK.gif"><img src="http://picstore.lliiooiill.cn/sBJuhIkD8Wv9XoK.gif" alt="GIF.gif"></a></p> <p>由此可得知，宏任务先于微任务执行，注意：<strong>每执行完一个宏任务，都要检查微任务队列是否为空，否则执行所有微任务</strong>，也就是说，微任务是一个接一个执行的，宏任务是一个一个分开执行的(这样说可能有点别扭，但我一时想不出更好的解释(＠_＠😉)。</p> <blockquote><p>有一些人认为微任务的优先级是高于宏任务的，这是因为他们忽略了整体 script，实际上整个 script 也是一个宏任务，在执行任何一个 script 文件的时候，js 引擎都会将内容包装在函数中，并将该函数与 start 或 start 事件关联，这个事件将被添加到宏任务中。</p></blockquote> <h4 id="优先级"><a href="#优先级" class="header-anchor">#</a> 优先级</h4> <p>既然宏任务先于微任务执行，那么宏任务之间，微任务之间是否也有优先级呢？</p> <p>答案是有！！！</p> <p><strong>宏任务优先级</strong>：</p> <p>script 整体代码 &gt; setImmediate &gt; MessageChannel &gt; setTimeout / setInterval</p> <p><strong>微任务优先级</strong>：</p> <p>process.nextTick &gt; Promise &gt; MutationObserver</p> <h4 id="settimeout-和-setimmediate-孰先孰后"><a href="#settimeout-和-setimmediate-孰先孰后" class="header-anchor">#</a> setTimeout 和 setImmediate 孰先孰后</h4> <p>我们说 setImmediate 优先级是高于 setTimeout，那为什么还要讨论呢，我们来看看下面的代码：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">789</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>按照优先级排序，答案很明显是先输出 789，后输出 end，然鹅：</p> <p><a data-fancybox="" title="1606192520.png" href="http://picstore.lliiooiill.cn/GIDE7RPl4MUKAJy.png"><img src="http://picstore.lliiooiill.cn/GIDE7RPl4MUKAJy.png" alt="1606192520.png"></a></p> <p>没错，我运行了两遍，因为第一次执行得出的结果和我预想的不同，执行第二次我发现 setImmediate 和 setTimeout 的回调执行顺序完全是随机的！</p> <p>这是为什么呢？来看看 node 官方文档的解释：</p> <blockquote><p>For example, if we run the following script which is not within an I/O cycle (i.e. the main module), the order in which the two timers are executed is non-deterministic, as it is bound by the performance of the process</p></blockquote> <p>意思是说，如果我们<strong>直接在主模块下面直接调用这两个方法，其回调执行顺序是随机的</strong>，因为这受到了进程性能的限制(这可能会受到计算机上运行的其他应用程序的影响)，但如果我们在一个 I/O 周期内调用这两个方法，那么就符合 setImmediate&gt;setTimeout 这个说法：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>__filename<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timeout'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'immediate'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="练习"><a href="#练习" class="header-anchor">#</a> 练习</h2> <p>现在我们来看这段比较长的代码巩固一下知识：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'start'</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timer1'</span><span class="token punctuation">)</span>
  <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise1'</span><span class="token punctuation">)</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'then1'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise2'</span><span class="token punctuation">)</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'then2'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'process1'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>来分析分析：</p> <ul><li>首先输出 <code>start</code></li> <li>第一个 setTimeout 简称 Timer1 的回调进入了宏任务队列</li> <li>输出 <code>promise2</code></li> <li>第二个 setTimeout 简称 Timer2 的回调进入了宏任务队列</li> <li>process.nextTick 的回调进入了微任务队列</li> <li>输出 <code>end</code></li></ul> <p>至此第一轮循环结束，开始第二轮，检测微任务队列：process.nextTick</p> <ul><li>process.nextTick 入栈，输出<code>process1</code></li></ul> <p>微任务队列清空，检测宏任务队列：Timer1，Timer2</p> <ul><li>Timer1 入栈，输出<code>timer1</code></li> <li>输出 <code>promise1</code></li> <li>第一个 promise.then 简称 Then1 的回调进入了微任务队列</li></ul> <p>检测微任务队列：Then1</p> <ul><li>Then1 入栈，第三个 setTimeout 简称 Timer3 的回调进入了宏任务队列</li></ul> <p>微任务队列清空，检测宏任务队列：Timer2，Timer3</p> <ul><li>Timer2 入栈，第二个 promise.then 简称 Then2 的回调进入了微任务队列</li></ul> <p>检测微任务队列：Then2</p> <ul><li>Then2 入栈，输出<code>then2</code></li></ul> <p>微任务队列清空，检测宏任务队列：Timer3</p> <ul><li>Timer3 入栈，输出<code>then1</code></li></ul> <p>完整的输出为：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>start
promise2
end
process1
timer1
promise1
then2
then1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">Notice</p> <p>以上所有例子的输出结果都是在 node12 的环境下运行，老版本可能输出结果会不一样。</p></div> <h2 id="扩展"><a href="#扩展" class="header-anchor">#</a> 扩展</h2> <h3 id="requestanimationframe"><a href="#requestanimationframe" class="header-anchor">#</a> requestAnimationFrame</h3> <p>我们在上面的内容里主要关注的是任务队列中回调的执行顺序，但实际上在 JS 线程执行完之后，浏览器<strong>可能</strong>会进行 GUI 渲染，之所以说可能，是因为<strong>每次执行完宏任务并不一定进行 GUI 渲染</strong>，每次进行 GUI 渲染的间隔为 16ms 左右，因为浏览器刷新频率为 60HZ，1000/60≈16ms。</p> <p>requestAnimationFrame 简称 RAF，其作用就是让浏览器流畅的执行动画效果，在进行 GUI 渲染的时候，就需要用到 RAF，RAF 执行完后，在进行重绘。</p> <p>使用 requestAnimationFrame 坐帧动画往往比 setTimeout 更具效率，性能更高。</p> <h2 id="使用工具"><a href="#使用工具" class="header-anchor">#</a> 使用工具</h2> <p><a href="http://latentflip.com/loupe/" target="_blank" rel="noopener noreferrer">loupe 查看执行栈和事件队列工具<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="参考文章"><a href="#参考文章" class="header-anchor">#</a> 参考文章</h2> <ul><li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/EventLoop" target="_blank" rel="noopener noreferrer">Concurrency model and the event loop<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://zhuanlan.zhihu.com/p/48590085" target="_blank" rel="noopener noreferrer">【译】理解 Javascript 执行上下文和执行栈<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://zhuanlan.zhihu.com/p/33058983" target="_blank" rel="noopener noreferrer">详解 JavaScript 中的 Event Loop（事件循环）机制<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://zhuanlan.zhihu.com/p/78113300" target="_blank" rel="noopener noreferrer">js 中的宏任务与微任务<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/#setimmediate-vs-settimeout" target="_blank" rel="noopener noreferrer">The Node.js Event Loop, Timers, and process.nextTick()<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://juejin.cn/post/6844903512845860872" target="_blank" rel="noopener noreferrer">这一次，彻底弄懂 JavaScript 执行机制<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后修改于:</span> <span class="time">7/21/2021, 8:44:12 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      🔙
      <a href="/technicalTopics/" class="prev router-link-active">
        前端技术专题
      </a></span> <span class="position-blank"></span> <span class="next"><a href="/technicalTopics/前端模块化发展.html">
        前端模块化发展
      </a>
      💨
    </span></p></div>  <section style="border-top:2px solid #eaecef;padding-top:1rem;margin-top:2rem;" data-v-55b2f3d7><div class="line" data-v-55b2f3d7></div> <div class="read-count" data-v-55b2f3d7><span data-flag-title="Your Article Title" class="leancloud-visitors" data-v-55b2f3d7><span class="post-meta-item-text" data-v-55b2f3d7>👁️‍🗨️ </span> <span class="leancloud-visitors-count" data-v-55b2f3d7></span></span></div> <h3 data-v-55b2f3d7><a href="javascript:;" data-v-55b2f3d7></a>
    评论💬：
  </h3> <div id="valine-vuepress-comment" data-v-55b2f3d7></div></section></main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.c065364e.js" defer></script><script src="/assets/js/2.daf612bb.js" defer></script><script src="/assets/js/3.1c386dd8.js" defer></script><script src="/assets/js/61.915390d9.js" defer></script>
  </body>
</html>
